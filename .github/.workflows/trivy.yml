name: Trivy Image Scanner

on:
  workflow_run:
    workflows: ["Build and Push Docker Image to Docker Hub and GHCR using VERSION file"]  # âœ… updated
    types:
      - completed

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  trivy-scan:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read VERSION file
        id: get_version
        run: echo "version=$(cat VERSION)" >> "$GITHUB_OUTPUT"

      - name: Set lowercase image name
        id: image
        run: |
          IMAGE_NAME=$(echo "${{ github.repository }}" | awk -F'/' '{print $2}' | tr '[:upper:]' '[:lower:]')
          echo "name=$IMAGE_NAME" >> "$GITHUB_OUTPUT"

      - name: Pull GHCR image
        run: docker pull ghcr.io/${{ steps.image.outputs.name }}:${{ steps.get_version.outputs.version }}

      - name: Pull Docker Hub image
        run: docker pull oste/${{ steps.image.outputs.dockerhub_image }}:${{ steps.get_version.outputs.version }}

      - name: Scan GHCR image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ steps.image.outputs.name }}:${{ steps.get_version.outputs.version }}
          format: sarif
          output: trivy-ghcr.sarif
      - name: Scan Docker Hub image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: oste/${{ steps.image.outputs.name }}:${{ steps.get_version.outputs.version }}
          format: sarif
          output: trivy-dockerhub.sarif

      - name: Upload GHCR scan SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-ghcr.sarif
          category: trivy-ghcr

      - name: Upload Docker Hub scan SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-dockerhub.sarif
          category: trivy-dockerhub
